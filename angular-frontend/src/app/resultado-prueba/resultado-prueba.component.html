<div class="results-container">
  <header class="results-header">
    <button mat-button type="button" (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
      Volver
    </button>

    <div class="results-header__info">
      <h1>{{ competition?.name || "Resultados World Aquatics" }}</h1>
      @if(competition?.location || competition?.dateLabel) {
      <p class="meta">
        @if(competition?.location){
        <span>{{ competition?.location }}</span>
        } @if(competition?.location && competition?.dateLabel){
        <span class="separator">•</span>
        } @if(competition?.dateLabel){
        <span>{{ competition?.dateLabel }}</span>
        }
      </p>
      }
    </div>

    <button
      mat-stroked-button
      color="primary"
      type="button"
      (click)="refreshEvents()"
    >
      <mat-icon>refresh</mat-icon>
      Recargar
    </button>
  </header>

  @if (eventsLoading) {
  <div class="state-block loading">
    <mat-progress-spinner
      diameter="48"
      mode="indeterminate"
    ></mat-progress-spinner>
    <p><strong>Cargando eventos...</strong></p>
    <p class="loading-hint">
      Esto puede tardar entre 30-60 segundos mientras se procesan los resultados
    </p>
  </div>
  } @else if (eventsError) {
  <div class="state-block error">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ eventsError }}</p>
    <button
      mat-raised-button
      color="primary"
      type="button"
      (click)="refreshEvents()"
    >
      Reintentar
    </button>
  </div>
  } @else {
  <div class="results-layout">
    <!-- Panel de selección de prueba y series -->
    <section class="selection-panel">
      <mat-card>
        <mat-card-content>
          <!-- Select de Pruebas -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>
              <mat-icon class="select-icon">pool</mat-icon>
              Seleccionar Prueba de Natación
            </mat-label>
            <mat-select
              [(ngModel)]="selectedEventGuid"
              (selectionChange)="selectEvent($event.value)"
              placeholder="Elige una prueba..."
            >
              @for (event of filteredEvents; track event.eventGuid) {
              <mat-option [value]="event.eventGuid">
                <div class="event-option">
                  <div class="event-option__text">
                    <span class="event-option__title">{{ event.title }}</span>
                    @if(event.subtitle) {
                    <small class="event-option__subtitle">{{ event.subtitle }}</small>
                    }
                  </div>

                </div>
              </mat-option>
              }
            </mat-select>
            <mat-hint>{{ events.length }} pruebas de natación disponibles</mat-hint>
          </mat-form-field>

          <!-- Radio buttons para Series -->
          @if (selectedEvent && selectedEvent.units && selectedEvent.units.length) {
          <div class="units-section">
            <h3 class="units-title">
              <mat-icon>waves</mat-icon>
              Series disponibles
            </h3>
            <mat-radio-group
              class="units-radio-group"
              [(ngModel)]="selectedUnitId"
              (change)="onUnitChange($event.value)"
            >
              @for (unit of selectedEvent.units; track unit.unitId) {
              <mat-radio-button
                [value]="unit.unitId"
                class="unit-radio"
                [disabled]="tableLoading"
              >
                <div class="unit-label">
                  <div class="unit-label__main">
                    <mat-icon class="unit-label__icon">schedule</mat-icon>
                    <span class="unit-label__name">{{ unit.name || 'Serie ' + (unit.order || '') }}</span>
                    @if (unit.status) {
                    <span
                      class="unit-label__status"
                      [class.official]="unit.status && unit.status.toLowerCase().includes('official')"
                    >
                      {{ unit.status }}
                    </span>
                    }
                  </div>
                  @if (unit.datetime) {
                  <small class="unit-label__datetime">{{ unit.datetime }}</small>
                  }
                </div>
              </mat-radio-button>
              }
            </mat-radio-group>
          </div>
          }
        </mat-card-content>
      </mat-card>
    </section>

    <!-- Panel de resultados -->
    <section class="details-panel">
      @if (selectedEvent) {
      <mat-card class="event-details">
        <mat-card-header>
          <div class="details-heading">
            <mat-icon class="details-heading__icon">{{ getEventIcon(selectedEvent) }}</mat-icon>
            <div>
              <h2>{{ selectedEvent.title }}</h2>
              @if (selectedEvent.subtitle) {
              <p>{{ selectedEvent.subtitle }}</p>
              }
            </div>
          </div>
          @if (selectedEvent.discipline) {
          <span class="discipline-tag">
            {{ selectedEvent.discipline }}
          </span>
          }
        </mat-card-header>
        <mat-card-content>
          <div class="table-wrapper">
            @if (tableLoading) {
            <div class="state-block loading">
              <mat-progress-spinner
                diameter="40"
                mode="indeterminate"
              ></mat-progress-spinner>
              <p>Cargando resultados...</p>
            </div>
            } @else if (tableError) {
            <div class="state-block error">
              <mat-icon color="warn">error</mat-icon>
              <p>{{ tableError }}</p>
              <button
                mat-button
                color="primary"
                type="button"
                (click)="
                  selectedEvent &&
                    loadEventResults(selectedEvent.eventGuid, selectedUnitId)
                "
              >
                Reintentar
              </button>
            </div>
            } @else if (currentTable?.rows?.length) {
            <div class="table-scroll">
              <table>
                <thead>
                  <tr>
                    <th style="width: 40px"></th>
                    <th>Overall Rank</th>
                    <th>Lane</th>
                    <th>Country</th>
                    <th>Athlete</th>
                    <th>Age</th>
                    <th>RT</th>
                    <th>Time</th>
                    <th>Time Behind</th>
                    <th>Points</th>
                  </tr>
                </thead>
                <tbody>
                  @for (row of currentTable?.rows; track trackByRow($index,
                  row)) {
                  <!-- Fila principal -->
                  <tr class="athlete-row">
                    <td class="expand-button-cell">
                      @if (row.hasSplits) {
                      <button
                        type="button"
                        class="expand-btn"
                        [class.expanded]="row.expanded"
                        (click)="toggleSplits(row)"
                      >
                        {{ row.expanded ? "−" : "+" }}
                      </button>
                      }
                    </td>
                    @for (cell of row.data; track trackByColumn($index, cell)) {
                    <td>{{ cell }}</td>
                    }
                  </tr>

                  <!-- Splits (solo si expandido) -->
                  @if (row.expanded && row.splits?.length) {
                  <tr class="split-header-row">
                    <td colspan="4"></td>
                    <td><strong>Distancia</strong></td>
                    <td><strong>Parcial</strong></td>
                    <td><strong>Acumulado</strong></td>
                    <td colspan="3"></td>
                  </tr>
                  @for (split of row.splits; track $index) {
                  <tr class="split-row">
                    <td colspan="4"></td>
                    <td>{{ split.distance }}</td>
                    <td>{{ split.splitTime }}</td>
                    <td>{{ split.cumulativeTime }}</td>
                    <td colspan="3"></td>
                  </tr>
                  } } }
                </tbody>
              </table>
            </div>
            } @else {
            <div class="state-block empty">
              <mat-icon>table_rows</mat-icon>
              <p>Sin resultados disponibles para esta serie.</p>
            </div>
            }
          </div>
        </mat-card-content>
      </mat-card>
      } @else {
      <div class="details-placeholder">
        <mat-icon>pool</mat-icon>
        <p>Selecciona una prueba y una serie para ver los resultados.</p>
      </div>
      }
    </section>
  </div>
  }
</div>
