<mat-sidenav-container class="nav-layout">
  <mat-sidenav #sidenav mode="over" class="mobile-nav">
    <div class="mobile-nav__header">
      <div class="logo-pill">
        <mat-icon>pool</mat-icon>
      </div>
      <div>
        <p class="eyebrow">Swim Suite</p>
        <strong>Panel avanzado</strong>
      </div>
      <button mat-icon-button (click)="sidenav.close()" aria-label="Cerrar menú">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    @if (authService.isLoggedIn()) {
      <div class="mobile-nav__status">
        <span>Sesión activa</span>
        <small>{{ userFullName }}</small>
      </div>
    }

    <mat-nav-list>
      @for (item of visibleMenuItems; track item.route) {
        <a mat-list-item [routerLink]="item.route" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: item.route === '/' }" (click)="sidenav.close()">
          <mat-icon matListItemIcon>{{ item.icon }}</mat-icon>
          <span matListItemTitle>{{ item.label }}</span>
          <mat-icon matListItemMeta>chevron_right</mat-icon>
        </a>
      }
    </mat-nav-list>

    @if (authService.isLoggedIn()) {
      <button mat-stroked-button color="accent" class="mobile-nav__cta" (click)="logout()">
        <mat-icon>logout</mat-icon>
        Cerrar sesión
      </button>
    }
  </mat-sidenav>

  <mat-sidenav-content>
    <mat-toolbar class="glass-toolbar">
      <div class="toolbar-grid">
        <div class="brand-section">
          <button mat-icon-button class="menu-btn" (click)="sidenav.toggle()" aria-label="Abrir menú">
            <mat-icon>menu</mat-icon>
          </button>

          <div class="brand" [routerLink]="'/'">
            <span class="logo-mark">
              <mat-icon class="wave">pool</mat-icon>
            </span>
            <div class="brand-copy">
              <strong>SwimLive</strong>
            </div>
          </div>
        </div>

        <nav class="desktop-links">
          @for (item of visibleMenuItems; track item.route) {
            <a
              mat-button
              [routerLink]="item.route"
              routerLinkActive="active"
              [routerLinkActiveOptions]="{ exact: item.route === '/' }"
              [matTooltip]="item.label"
              matTooltipPosition="below"
            >
              <mat-icon>{{ item.icon }}</mat-icon>
              <span>{{ item.label }}</span>
            </a>
          }
        </nav>

        <div class="toolbar-actions">
          <button
            mat-icon-button
            (click)="toggleTheme()"
            [matTooltip]="isDarkMode ? 'Modo claro' : 'Modo oscuro'"
          >
            <mat-icon>{{ isDarkMode ? 'light_mode' : 'dark_mode' }}</mat-icon>
          </button>

          @if (canShowNotificationBell()) {
            <button
              mat-icon-button
              matTooltip="Notificaciones"
              class="notification"
              [matMenuTriggerFor]="notificationMenu"
            >
              <mat-icon
                [matBadge]="pendingNotifications"
                [matBadgeHidden]="pendingNotifications === 0"
                matBadgeColor="warn"
                matBadgeSize="small"
                aria-label="Tienes notificaciones pendientes"
                >notifications</mat-icon
              >
            </button>
          }

          <mat-menu #notificationMenu="matMenu" class="notification-menu" (menuOpened)="onNotificationsMenuOpened()">
            <div class="notification-menu__container">
              @if (loadingNotifications) {
                <div class="notification-menu__empty">Cargando notificaciones...</div>
              } @else if (notifications.length === 0) {
                <div class="notification-menu__empty">No tienes notificaciones</div>
              } @else {
                @for (notification of notifications; track notification.id) {
                  <div class="notification-item" [class.notification-item--pending]="notification.status === 'pendiente'">
                    <div class="notification-item__header">
                      <span class="notification-item__title">{{ notification.title }}</span>
                      <span class="notification-item__status">{{ notificationStatusLabel(notification) }}</span>
                    </div>
                    @if (notification.message) {
                      <div class="notification-item__message">{{ notification.message }}</div>
                    }
                    <div class="notification-item__meta">
                      <span>{{ notification.createdAt | date: 'short' }}</span>
                      @if (notification.competitionName) {
                        <span class="notification-item__meta-separator">•</span>
                        <span>{{ notification.competitionName }}</span>
                      }
                    </div>
                    @if (notification.status === 'pendiente') {
                      <div class="notification-item__actions">
                        <button mat-stroked-button color="primary" (click)="respondToNotification(notification, 'accept', $event)">
                          Confirmar
                        </button>
                        <button mat-stroked-button color="warn" (click)="respondToNotification(notification, 'reject', $event)">
                          Rechazar
                        </button>
                      </div>
                    }
                  </div>
                }
              }
            </div>
          </mat-menu>

          @if (authService.isLoggedIn()) {
            <button class="user-chip" mat-button [matMenuTriggerFor]="userMenu" [matTooltip]="userFullName">
              <div class="avatar" [class.avatar--image]="userAvatar">
                @if (userAvatar) {
                  <img [src]="userAvatar" [alt]="userFullName" loading="lazy">
                } @else {
                  <span>{{ userInitials }}</span>
                }
              </div>
              <span class="user-name">{{ userFullName }}</span>
              <mat-icon>expand_more</mat-icon>
            </button>
          }
        </div>
      </div>
    </mat-toolbar>

    <mat-menu #userMenu="matMenu" class="user-menu">
      <button mat-menu-item (click)="goToProfile()">
        <mat-icon>person</mat-icon>
        <span>Ver perfil</span>
      </button>
      <button mat-menu-item (click)="logout()">
        <mat-icon>logout</mat-icon>
        <span>Cerrar sesión</span>
      </button>
    </mat-menu>

    <div class="page-surface">
      <div class="gradient-backdrop"></div>
      <div class="page-content">
        <router-outlet></router-outlet>
      </div>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>
