<div class="buscar-atletas-wrapper">
  <mat-card class="header-card mat-elevation-z4">
    <div class="header-content">
      <div class="header-text">
        <h1>
          <mat-icon>search</mat-icon>
          Buscar Atletas
        </h1>
        <p class="subtitle">Explora todos los nadadores registrados en la base de datos</p>
      </div>
    </div>
  </mat-card>

  <mat-card class="filters-card mat-elevation-z2">
    <form [formGroup]="searchForm" (ngSubmit)="onSearch()">
      <div class="filters-grid">
        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Buscar por nombre</mat-label>
          <input 
            matInput 
            formControlName="name" 
            placeholder="Ej: Katie Ledecky"
            autocomplete="off">
          <mat-icon matPrefix>person_search</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Nacionalidad</mat-label>
          <mat-select formControlName="nationality">
            <mat-option value="">Todas las nacionalidades</mat-option>
            @for (nat of nationalities; track nat) {
              <mat-option [value]="nat">
                <span [innerHTML]="nat | countryFlag"></span>
                {{ nat }}
              </mat-option>
            }
          </mat-select>
          <mat-icon matPrefix>flag</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" class="filter-field">
          <mat-label>Género</mat-label>
          <mat-select formControlName="gender">
            @for (gender of genders; track gender.value) {
              <mat-option [value]="gender.value">{{ gender.label }}</mat-option>
            }
          </mat-select>
          <mat-icon matPrefix>wc</mat-icon>
        </mat-form-field>

       
      </div>

      <div class="filters-actions">
        <button 
          mat-raised-button 
          color="primary" 
          type="submit"
          [disabled]="loading">
          <mat-icon>search</mat-icon>
          Buscar
        </button>
        
        <button 
          mat-stroked-button 
          type="button" 
          (click)="onReset()"
          [disabled]="loading || !hasFiltersApplied">
          <mat-icon>clear</mat-icon>
          Limpiar filtros
        </button>

        @if (hasFiltersApplied) {
          <mat-chip class="active-filters-chip" color="accent">
            <mat-icon>filter_alt</mat-icon>
            Filtros activos
          </mat-chip>
        }
      </div>
    </form>
  </mat-card>

  @if (loading) {
    <mat-card class="loading-card mat-elevation-z2">
      <mat-progress-spinner mode="indeterminate" diameter="60"></mat-progress-spinner>
      <p>Cargando atletas...</p>
    </mat-card>
  }

  @if (error) {
    <mat-card class="error-card mat-elevation-z2">
      <mat-icon color="warn">error</mat-icon>
      <p>{{ error }}</p>
      <button mat-raised-button color="primary" (click)="loadAthletes()">
        <mat-icon>refresh</mat-icon>
        Reintentar
      </button>
    </mat-card>
  }

  @if (!loading && !error) {
    <mat-card class="results-card mat-elevation-z2">
      <div class="results-header">
        <h2>
          <mat-icon>people</mat-icon>
          Resultados
        </h2>
        <p class="results-count">{{ resultadosTexto }}</p>
      </div>

      @if (filteredAthletes.length === 0) {
        <div class="no-results">
          <mat-icon>search_off</mat-icon>
          <h3>No se encontraron atletas</h3>
          <p>Intenta ajustar los filtros de búsqueda</p>
        </div>
      } @else {
        <div class="athletes-grid">
          @for (athlete of paginatedAthletes; track athlete.athleteId || athlete.name) {
            <div class="athlete-card" (click)="verPerfil(athlete)">
              <div class="athlete-image">
                @if (athlete.imageUrl) {
                  <img 
                    [src]="athlete.imageUrl" 
                    [alt]="athlete.name"
                    (error)="onImageError($event)"
                    loading="lazy">
                } @else {
                  <div class="image-placeholder">
                    <mat-icon>person</mat-icon>
                  </div>
                }
              </div>

              <div class="athlete-info">
                <h3 class="athlete-name">{{ athlete.name }}</h3>
                
                <div class="athlete-details">
                  @if (athlete.nationality || athlete.country) {
                    <span class="detail-item">
                      <mat-icon>flag</mat-icon>
                      <span [innerHTML]="(athlete.nationality || athlete.country) | countryFlag"></span>
                      {{ athlete.nationality || athlete.country }}
                    </span>
                  }

                  @if (athlete.gender) {
                    <span class="detail-item">
                      <mat-icon>wc</mat-icon>
                      {{ getGenderLabel(athlete.gender) }}
                    </span>
                  }

                  @if (athlete.age) {
                    <span class="detail-item">
                      <mat-icon>cake</mat-icon>
                      {{ athlete.age }} años
                    </span>
                  }

                  @if (athlete.club) {
                    <span class="detail-item club">
                      <mat-icon>groups</mat-icon>
                      {{ athlete.club }}
                    </span>
                  }
                </div>

                @if (athlete.bestResults && athlete.bestResults.length > 0) {
                  <div class="best-results">
                    <mat-icon>emoji_events</mat-icon>
                    <span>{{ athlete.bestResults.length }} mejor{{ athlete.bestResults.length !== 1 ? 'es' : '' }} marca{{ athlete.bestResults.length !== 1 ? 's' : '' }}</span>
                  </div>
                }
              </div>

              <div class="athlete-action">
                <mat-icon>chevron_right</mat-icon>
              </div>
            </div>
          }
        </div>

        @if (totalAthletes > pageSize) {
          <mat-paginator
            [length]="totalAthletes"
            [pageSize]="pageSize"
            [pageSizeOptions]="[10, 20, 50, 100]"
            [pageIndex]="pageIndex"
            (page)="onPageChange($event)"
            showFirstLastButtons>
          </mat-paginator>
        }
      }
    </mat-card>
  }
</div>
