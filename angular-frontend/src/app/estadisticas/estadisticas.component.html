<div class="estadisticas-page">
  <mat-card class="hero-card">
    <div class="hero__glow"></div>
    <div class="hero__grid">
      <div class="hero__copy">
        <p class="eyebrow">Radar de datos</p>
        <h1>Estadisticas vivas</h1>
        <p class="lede">
          Un panel ligero para seguir el pulso de las competiciones, rachas de atletas y el estado de tus feeds.
        </p>
        <div class="hero__actions">
          <button mat-raised-button color="primary" (click)="refresh()">
            <mat-icon>autorenew</mat-icon>
            Refrescar feed
          </button>

        </div>

      </div>

      <div class="hero__panel">
        <div class="panel-head">
          <p class="eyebrow">En la ultima hora</p>
          <span class="pill muted">{{ competitionPulse.length }} eventos</span>
        </div>
        <div class="mini-bars">
          @for (pace of pacePreview; track pace.label) {
            <div class="mini-bar">
              <div class="mini-bar__label">
                <mat-icon>{{ pace.icon }}</mat-icon>
                <span>{{ pace.label }}</span>
              </div>
              <div class="mini-bar__track">
                <div class="mini-bar__fill" [style.width.%]="pace.progress"></div>
              </div>
              <span class="mini-bar__value">{{ pace.value }}</span>
            </div>
          }
        </div>
        <div class="hero__list">
          @for (comp of competitionPulse; track comp.name) {
            <div class="hero__item">
              <div class="dot" [ngClass]="getStatusClass(comp.status)"></div>
              <div>
                <strong>{{ comp.name }}</strong>
                <p class="meta">
                  @if (comp.countryCode) {
                    <span>{{ comp.countryCode | countryFlag }}</span>
                  }
                  @if (comp.city) {
                    <span>{{ comp.city | cityName }}</span>
                  }
                  <span>{{ formatDateLabel(comp) }}</span>
                </p>
              </div>
              <span class="pill" [ngClass]="getStatusClass(comp.status)">{{ getStatusLabel(comp.status) }}</span>
            </div>
          }
        </div>
      </div>
    </div>
  </mat-card>

  @if (loading) {
    <div class="loading-block">
      <mat-progress-bar mode="indeterminate" color="primary"></mat-progress-bar>
      <span>Sincronizando datos frescos...</span>
    </div>
  }

  <div class="stat-grid">
    @for (card of summaryCards; track card.key) {
      <mat-card class="stat-card" [ngClass]="card.accent">
        <div class="stat-card__head">
          <div class="icon-pill">
            <mat-icon>{{ card.icon }}</mat-icon>
          </div>
          <div class="trend" [ngClass]="{ up: card.trend >= 0, down: card.trend < 0 }">
            <mat-icon>{{ card.trend >= 0 ? 'arrow_outward' : 'south' }}</mat-icon>
            <span>{{ card.trend }}%</span>
          </div>
        </div>
        <div class="stat-card__body">
          <p class="label">{{ card.title }}</p>
          <p class="value">{{ card.value }}</p>
          <p class="helper">{{ card.helper }}</p>
        </div>
      </mat-card>
    }
  </div>

  <div class="panel-grid">
    <mat-card class="panel">
      <div class="panel__header">
        <div>
          <p class="eyebrow">Ritmo por estilo</p>
          <h2>Intensidad promedio</h2>
        </div>
        <a mat-stroked-button color="primary" routerLink="/nadadores">
          <mat-icon>leaderboard</mat-icon>
          Ver ranking
        </a>
      </div>
      <div class="bar-list">
        @for (pace of paceByStroke; track pace.label) {
          <div class="bar-row">
            <div class="bar-row__label">
              <mat-icon>{{ pace.icon }}</mat-icon>
              <span>{{ pace.label }}</span>
            </div>
            <div class="bar-row__track">
              <div class="bar-row__fill" [style.width.%]="pace.progress"></div>
            </div>
            <span class="bar-row__value">{{ pace.value }}</span>
          </div>
        }
      </div>
    </mat-card>

    @if (olympicLeader || goldLeaders || silverLeaders || worldRecordLeaders) {
      <mat-card class="panel hall-card">
        <div class="panel__header">
          <div>
            <p class="eyebrow">Hall of fame</p>
            <h2>Lideres por medallas</h2>
          </div>
        </div>
        <div class="hall-grid">
          @if (olympicLeader) {
            <div class="hall-highlight">
              <div class="hall-highlight__badge">
                <mat-icon>emoji_events</mat-icon>
                <span>Records olímpicos</span>
              </div>
              <div class="hall-highlight__body">
                <div class="avatar">
                  <span>{{ olympicLeader.name.charAt(0) }}</span>
                </div>
                <div>
                  <strong>{{ olympicLeader.name }}</strong>
                  <p class="meta">
                    @if (olympicLeader.countryCode) {
                      <span class="flag">{{ olympicLeader.countryCode | countryFlag }}</span>
                    }
                    <span>{{ olympicLeader.records }} OR</span>
                  </p>
                </div>
              </div>
              <p class="hall-highlight__note">Máximo número de registros olímpicos etiquetados como OR.</p>
            </div>
          }

          @if (goldLeaders) {
            <div class="hall-section">
              <div class="hall-section__head gold">
                <mat-icon>military_tech</mat-icon>
                <span>Medallas de oro</span>
              </div>
              <div class="gender-grid">
                @if (goldLeaders.male) {
                  <div class="gender-card">
                    <p class="label">Masculino</p>
                    <strong>{{ goldLeaders.male.name }}</strong>
                    <p class="meta">
                      @if (goldLeaders.male.countryCode) {
                        <span class="flag">{{ goldLeaders.male.countryCode | countryFlag }}</span>
                      }
                      <span>{{ goldLeaders.male.value }} oros</span>
                    </p>
                  </div>
                }
                @if (goldLeaders.female) {
                  <div class="gender-card">
                    <p class="label">Femenino</p>
                    <strong>{{ goldLeaders.female.name }}</strong>
                    <p class="meta">
                      @if (goldLeaders.female.countryCode) {
                        <span class="flag">{{ goldLeaders.female.countryCode | countryFlag }}</span>
                      }
                      <span>{{ goldLeaders.female.value }} oros</span>
                    </p>
                  </div>
                }
              </div>
            </div>
          }

          @if (silverLeaders) {
            <div class="hall-section">
              <div class="hall-section__head silver">
                <mat-icon>workspace_premium</mat-icon>
                <span>Medallas de plata</span>
              </div>
              <div class="gender-grid">
                @if (silverLeaders.male) {
                  <div class="gender-card">
                    <p class="label">Masculino</p>
                    <strong>{{ silverLeaders.male.name }}</strong>
                    <p class="meta">
                      @if (silverLeaders.male.countryCode) {
                        <span class="flag">{{ silverLeaders.male.countryCode | countryFlag }}</span>
                      }
                      <span>{{ silverLeaders.male.value }} platas</span>
                    </p>
                  </div>
                }
                @if (silverLeaders.female) {
                  <div class="gender-card">
                    <p class="label">Femenino</p>
                    <strong>{{ silverLeaders.female.name }}</strong>
                    <p class="meta">
                      @if (silverLeaders.female.countryCode) {
                        <span class="flag">{{ silverLeaders.female.countryCode | countryFlag }}</span>
                      }
                      <span>{{ silverLeaders.female.value }} platas</span>
                    </p>
                  </div>
                }
              </div>
            </div>
          }

          @if (worldRecordLeaders) {
            <div class="hall-section">
              <div class="hall-section__head wr">
                <mat-icon>star</mat-icon>
                <span>Record WR</span>
              </div>
              <div class="gender-grid">
                @if (worldRecordLeaders.male) {
                  <div class="gender-card">
                    <p class="label">Masculino</p>
                    <strong>{{ worldRecordLeaders.male.name }}</strong>
                    <p class="meta">
                      @if (worldRecordLeaders.male.countryCode) {
                        <span class="flag">{{ worldRecordLeaders.male.countryCode | countryFlag }}</span>
                      }
                      <span>{{ worldRecordLeaders.male.value }} WR</span>
                    </p>
                  </div>
                }
                @if (worldRecordLeaders.female) {
                  <div class="gender-card">
                    <p class="label">Femenino</p>
                    <strong>{{ worldRecordLeaders.female.name }}</strong>
                    <p class="meta">
                      @if (worldRecordLeaders.female.countryCode) {
                        <span class="flag">{{ worldRecordLeaders.female.countryCode | countryFlag }}</span>
                      }
                      <span>{{ worldRecordLeaders.female.value }} WR</span>
                    </p>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </mat-card>
    }
  </div>

  <div class="panel-grid">
    <mat-card class="panel">
      <div class="panel__header">
        <div>
          <p class="eyebrow">Atletas destacados</p>
          <h2>Rachas rapidas</h2>
        </div>
        <button mat-icon-button matTooltip="Refrescar ranking" (click)="refresh()">
          <mat-icon>refresh</mat-icon>
        </button>
      </div>

      <div class="athlete-grid">
        @for (athlete of topAthletes; track athlete.name) {
          <div class="athlete-card">
            <div class="avatar">
              <span>{{ athlete.name.charAt(0) }}</span>
            </div>
            <div class="athlete-card__body">
              <div class="row">
                <strong>{{ athlete.name }}</strong>
                @if (athlete.country) {
                  <span class="flag">{{ athlete.country | countryFlag }}</span>
                }
              </div>
              <p class="event">{{ athlete.event }}</p>
              <div class="tags">
                <span class="pill success">{{ athlete.time }}</span>
                @if (athlete.points) {
                  <span class="pill muted">{{ athlete.points }} pts</span>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </mat-card>

  </div>

  <div class="panel-grid">
    <mat-card class="panel scheduled-panel">
      <div class="panel__header">
        <div>
          <p class="eyebrow">Competiciones agendadas</p>
          <h2>Agenda local</h2>
        </div>
        <span class="pill muted">{{ scheduledCompetitions.length }} registradas</span>
      </div>

      @if (scheduledCompetitions.length === 0) {
        <div class="empty-state">
          <mat-icon>event_busy</mat-icon>
          <p>Todavia no hay competiciones programadas.</p>
        </div>
      } @else {
        <div class="scheduled-metrics">
          @for (metric of scheduledStatusMetrics; track metric.status) {
            <div class="scheduled-metric" [ngClass]="metric.accent">
              <div class="metric-icon">
                <mat-icon>{{ metric.icon }}</mat-icon>
              </div>
              <div>
                <p class="label">{{ metric.label }}</p>
                <p class="value">{{ metric.value }}</p>
              </div>
            </div>
          }
        </div>

        <div class="scheduled-list">
          @for (comp of scheduledHighlights; track comp.id ?? comp.nombre) {
            <div class="scheduled-item">
              <div class="scheduled-item__body">
                <strong>{{ comp.nombre }}</strong>
                <p class="meta">
                  @if (comp.pais) {
                    <span>{{ comp.pais }}</span>
                  }
                  @if (comp.ciudad) {
                    <span>{{ comp.ciudad }}</span>
                  }
                  @if (comp.fecha_inicio) {
                    <span>{{ formatScheduledDate(comp.fecha_inicio) }}</span>
                  }
                </p>
              </div>
              <span class="pill estado-chip" [ngClass]="'estado-' + (comp.estado || 'pendiente')">
                {{ getEstadoLabel(comp.estado) }}
              </span>
            </div>
          }
        </div>
      }
    </mat-card>
  </div>

  @if (error) {
    <div class="inline-warning">
      <mat-icon>info</mat-icon>
      <span>{{ error }}</span>
    </div>
  }
</div>
