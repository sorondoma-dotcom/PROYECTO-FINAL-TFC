<div class="estadisticas-page">
  <mat-card class="hero-card">
    <div class="hero__glow"></div>
    <div class="hero__grid">
      <div class="hero__copy">
        <p class="eyebrow">Radar de datos</p>
        <h1>Estadisticas vivas</h1>
        <p class="lede">
          Un panel ligero para seguir el pulso de las competiciones, rachas de atletas y el estado de tus feeds.
        </p>
        <div class="hero__actions">
          <button mat-raised-button color="primary" (click)="refresh()">
            <mat-icon>autorenew</mat-icon>
            Refrescar feed
          </button>
          <a mat-stroked-button color="primary" routerLink="/resultado-prueba">
            <mat-icon>insights</mat-icon>
            Ver resultados
          </a>
        </div>
        <div class="hero__chips">
          <mat-chip class="pill success">
            <mat-icon>bolt</mat-icon>
            Pulso en vivo
          </mat-chip>
          <mat-chip class="pill muted">
            <mat-icon>verified</mat-icon>
            Datos curados
          </mat-chip>
        </div>
      </div>

      <div class="hero__panel">
        <div class="panel-head">
          <p class="eyebrow">En la ultima hora</p>
          <span class="pill muted">{{ competitionPulse.length }} eventos</span>
        </div>
        <div class="mini-bars">
          @for (pace of pacePreview; track pace.label) {
            <div class="mini-bar">
              <div class="mini-bar__label">
                <mat-icon>{{ pace.icon }}</mat-icon>
                <span>{{ pace.label }}</span>
              </div>
              <div class="mini-bar__track">
                <div class="mini-bar__fill" [style.width.%]="pace.progress"></div>
              </div>
              <span class="mini-bar__value">{{ pace.value }}</span>
            </div>
          }
        </div>
        <div class="hero__list">
          @for (comp of competitionPulse; track comp.name) {
            <div class="hero__item">
              <div class="dot" [ngClass]="getStatusClass(comp.status)"></div>
              <div>
                <strong>{{ comp.name }}</strong>
                <p class="meta">
                  @if (comp.countryCode) {
                    <span>{{ comp.countryCode | countryFlag }}</span>
                  }
                  @if (comp.city) {
                    <span>{{ comp.city | cityName }}</span>
                  }
                  <span>{{ formatDateLabel(comp) }}</span>
                </p>
              </div>
              <span class="pill" [ngClass]="getStatusClass(comp.status)">{{ getStatusLabel(comp.status) }}</span>
            </div>
          }
        </div>
      </div>
    </div>
  </mat-card>

  @if (loading) {
    <div class="loading-block">
      <mat-progress-bar mode="indeterminate" color="primary"></mat-progress-bar>
      <span>Sincronizando datos frescos...</span>
    </div>
  }

  <div class="stat-grid">
    @for (card of summaryCards; track card.key) {
      <mat-card class="stat-card" [ngClass]="card.accent">
        <div class="stat-card__head">
          <div class="icon-pill">
            <mat-icon>{{ card.icon }}</mat-icon>
          </div>
          <div class="trend" [ngClass]="{ up: card.trend >= 0, down: card.trend < 0 }">
            <mat-icon>{{ card.trend >= 0 ? 'arrow_outward' : 'south' }}</mat-icon>
            <span>{{ card.trend }}%</span>
          </div>
        </div>
        <div class="stat-card__body">
          <p class="label">{{ card.title }}</p>
          <p class="value">{{ card.value }}</p>
          <p class="helper">{{ card.helper }}</p>
        </div>
      </mat-card>
    }
  </div>

  <div class="panel-grid">
    <mat-card class="panel">
      <div class="panel__header">
        <div>
          <p class="eyebrow">Ritmo por estilo</p>
          <h2>Intensidad promedio</h2>
        </div>
        <a mat-stroked-button color="primary" routerLink="/nadadores">
          <mat-icon>leaderboard</mat-icon>
          Ver ranking
        </a>
      </div>
      <div class="bar-list">
        @for (pace of paceByStroke; track pace.label) {
          <div class="bar-row">
            <div class="bar-row__label">
              <mat-icon>{{ pace.icon }}</mat-icon>
              <span>{{ pace.label }}</span>
            </div>
            <div class="bar-row__track">
              <div class="bar-row__fill" [style.width.%]="pace.progress"></div>
            </div>
            <span class="bar-row__value">{{ pace.value }}</span>
          </div>
        }
      </div>
    </mat-card>

    <mat-card class="panel">
      <div class="panel__header">
        <div>
          <p class="eyebrow">Pulso de competiciones</p>
          <h2>Lo que sucede hoy</h2>
        </div>
        <mat-chip class="pill muted">{{ competitionPulse.length }} activos</mat-chip>
      </div>

      @if (!loading && competitionPulse.length === 0) {
        <div class="empty-state">
          <mat-icon>visibility_off</mat-icon>
          <p>Sin eventos sincronizados ahora mismo.</p>
        </div>
      } @else {
        <div class="pulse-list">
          @for (comp of competitionPulse; track comp.name) {
            <div class="pulse-item">
              <div class="pulse-item__status" [ngClass]="getStatusClass(comp.status)"></div>
              <div class="pulse-item__body">
                <strong>{{ comp.name }}</strong>
                <div class="meta">
                  @if (comp.countryCode) {
                    <span>{{ comp.countryCode | countryFlag }}</span>
                  }
                  @if (comp.city) {
                    <span>{{ comp.city | cityName }}</span>
                  }
                  <span>{{ formatDateLabel(comp) }}</span>
                </div>
              </div>
              <span class="pill" [ngClass]="getStatusClass(comp.status)">{{ getStatusLabel(comp.status) }}</span>
            </div>
          }
        </div>
      }
    </mat-card>
  </div>

  <div class="panel-grid">
    <mat-card class="panel">
      <div class="panel__header">
        <div>
          <p class="eyebrow">Atletas destacados</p>
          <h2>Rachas rapidas</h2>
        </div>
        <button mat-icon-button matTooltip="Refrescar ranking" (click)="refresh()">
          <mat-icon>refresh</mat-icon>
        </button>
      </div>

      <div class="athlete-grid">
        @for (athlete of topAthletes; track athlete.name) {
          <div class="athlete-card">
            <div class="avatar">
              <span>{{ athlete.name.charAt(0) }}</span>
            </div>
            <div class="athlete-card__body">
              <div class="row">
                <strong>{{ athlete.name }}</strong>
                @if (athlete.country) {
                  <span class="flag">{{ athlete.country | countryFlag }}</span>
                }
              </div>
              <p class="event">{{ athlete.event }}</p>
              <div class="tags">
                <span class="pill success">{{ athlete.time }}</span>
                @if (athlete.points) {
                  <span class="pill muted">{{ athlete.points }} pts</span>
                }
              </div>
            </div>
          </div>
        }
      </div>
    </mat-card>

    <mat-card class="panel">
      <div class="panel__header">
        <div>
          <p class="eyebrow">Objetivos de cobertura</p>
          <h2>Roadmap semanal</h2>
        </div>
      </div>

      <div class="goal-list">
        @for (goal of focusGoals; track goal.title) {
          <div class="goal-card">
            <div class="goal-card__head">
              <div class="icon-pill small" [ngClass]="goal.accent">
                <mat-icon>{{ goal.icon }}</mat-icon>
              </div>
              <div>
                <p class="label">{{ goal.title }}</p>
                <p class="hint">{{ goal.hint }}</p>
              </div>
              <span class="goal-progress">{{ goal.progress }}%</span>
            </div>
            <mat-progress-bar [value]="goal.progress" mode="determinate" color="primary"></mat-progress-bar>
          </div>
        }
      </div>
    </mat-card>
  </div>

  <div class="panel-grid">
    <mat-card class="panel scheduled-panel">
      <div class="panel__header">
        <div>
          <p class="eyebrow">Competiciones agendadas</p>
          <h2>Agenda local</h2>
        </div>
        <span class="pill muted">{{ scheduledCompetitions.length }} registradas</span>
      </div>

      @if (scheduledCompetitions.length === 0) {
        <div class="empty-state">
          <mat-icon>event_busy</mat-icon>
          <p>Todavia no hay competiciones programadas.</p>
        </div>
      } @else {
        <div class="scheduled-metrics">
          @for (metric of scheduledStatusMetrics; track metric.status) {
            <div class="scheduled-metric" [ngClass]="metric.accent">
              <div class="metric-icon">
                <mat-icon>{{ metric.icon }}</mat-icon>
              </div>
              <div>
                <p class="label">{{ metric.label }}</p>
                <p class="value">{{ metric.value }}</p>
              </div>
            </div>
          }
        </div>

        <div class="scheduled-list">
          @for (comp of scheduledHighlights; track comp.id ?? comp.nombre) {
            <div class="scheduled-item">
              <div class="scheduled-item__body">
                <strong>{{ comp.nombre }}</strong>
                <p class="meta">
                  @if (comp.pais) {
                    <span>{{ comp.pais }}</span>
                  }
                  @if (comp.ciudad) {
                    <span>{{ comp.ciudad }}</span>
                  }
                  @if (comp.fecha_inicio) {
                    <span>{{ formatScheduledDate(comp.fecha_inicio) }}</span>
                  }
                </p>
              </div>
              <span class="pill estado-chip" [ngClass]="'estado-' + (comp.estado || 'pendiente')">
                {{ getEstadoLabel(comp.estado) }}
              </span>
            </div>
          }
        </div>
      }
    </mat-card>
  </div>

  @if (error) {
    <div class="inline-warning">
      <mat-icon>info</mat-icon>
      <span>{{ error }}</span>
    </div>
  }
</div>
