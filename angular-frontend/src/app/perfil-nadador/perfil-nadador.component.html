<div class="perfil-wrapper">
  <mat-card class="hero mat-elevation-z6">
    <div class="hero__topbar">
      <button mat-stroked-button color="primary" routerLink="/nadadores" class="back-btn">
        <mat-icon>arrow_back</mat-icon>
        Volver al ranking
      </button>
      <p class="breadcrumb">Nadadores · Perfil destacado</p>
    </div>

    <div class="hero__header">
      <div class="hero__photo-block">
        <div class="photo-frame">
          @if (athlete.imageUrl) {
            <img [src]="athlete.imageUrl" [alt]="athlete.name" loading="lazy">
          } @else {
            <div class="photo-placeholder">
              <mat-icon>person</mat-icon>
            </div>
          }
          <span class="photo-glow"></span>
        </div>
        <div class="mini-meta">
          <span class="pill">{{ athlete.club || 'Club no registrado' }}</span>
          <span class="pill pill--light">{{ athlete.country || athlete.nationality || 'Pais por confirmar' }}</span>
        </div>
      </div>

      <div class="hero__info">
        <p class="eyebrow">Enfocado en el agua</p>
        <h1>{{ athlete.name || 'Nadador' }}</h1>
        <p class="hero__tagline">
          {{ athlete.distance }}m · {{ getStrokeLabel(athlete.stroke) }} · {{ athlete.pool || 'Piscina' }}
        </p>
        <mat-chip-set class="chips">
          <mat-chip color="primary" selected>{{ athlete.gender === 'M' ? 'Masculino' : 'Femenino' }}</mat-chip>
          @if (athlete.age) { <mat-chip>{{ athlete.age }} anos</mat-chip> }
          <mat-chip>{{ athlete.nationality || athlete.country || 'Sin pais' }}</mat-chip>
          <mat-chip>Ranking dinamico</mat-chip>
        </mat-chip-set>
        <div class="hero__actions">
          <button mat-raised-button color="primary" (click)="loadRankingData()" [disabled]="loading">
            @if (loading) { Cargando... } @else { Refrescar datos }
          </button>
        </div>
      </div>

      <div class="hero__metric-stack">
        @if (records.length) {
          <div class="hero__metric">
            <p>Mejor marca</p>
            <h2>{{ records[0].bestTime }}</h2>
            <small>{{ records[0].competition || 'Competencia' }}</small>
          </div>
        }
        @if (athlete.medals) {
          <div class="hero__metric medals">
            <p>Medallas (WA/JO)</p>
            <div class="medal-row">
              <span class="gold">Oro {{ athlete.medals.gold }}</span>
              <span class="silver">Plata {{ athlete.medals.silver }}</span>
              <span class="bronze">Bronce {{ athlete.medals.bronze }}</span>
            </div>
          </div>
        }
      </div>
    </div>
  </mat-card>

  @if (viewingSelf && canEditProfile) {
    <mat-card class="panel profile-settings mat-elevation-z4">
      <div class="panel__header">
        <div>
          <p class="eyebrow">Tu cuenta</p>
          <h3>Actualiza tu perfil</h3>
        </div>
        @if (savingProfile) {
          <mat-progress-spinner diameter="24" mode="indeterminate"></mat-progress-spinner>
        }
      </div>

      <form class="profile-form" [formGroup]="profileForm" (ngSubmit)="submitProfile()">
        <div class="profile-form__grid">
          <div class="profile-form__avatar">
            <div class="avatar-preview" [class.avatar-preview--has-image]="avatarPreview">
              @if (avatarPreview) {
                <img [src]="avatarPreview" alt="Avatar actual" loading="lazy">
              } @else {
                <mat-icon>person</mat-icon>
              }
            </div>
            <div class="avatar-actions">
              @if (canUploadAvatar) {
                <button mat-stroked-button color="primary" type="button" (click)="fileInput.click()" [disabled]="savingProfile">
                  <mat-icon>photo_camera</mat-icon>
                  {{ accountUser?.avatarUrl ? 'Reemplazar foto' : 'Subir foto' }}
                </button>
                <input #fileInput type="file" accept="image/png,image/jpeg,image/webp" (change)="onAvatarSelected($event)" hidden>
              } @else {
                <p class="muted">Este rol no permite actualizar la foto de perfil.</p>
              }

              @if (selectedAvatar) {
                <button mat-button type="button" (click)="clearSelectedAvatar()" [disabled]="savingProfile">
                  <mat-icon>close</mat-icon>
                  Cancelar
                </button>
              }
            </div>
          </div>

          <div class="profile-form__fields">
            <mat-form-field appearance="outline">
              <mat-label>Nombre</mat-label>
              <input matInput formControlName="name" autocomplete="off" [disabled]="!canEditProfile">
              @if (profileForm.get('name')?.hasError('required')) {
                <mat-error>El nombre es obligatorio.</mat-error>
              } @else if (profileForm.get('name')?.hasError('minlength')) {
                <mat-error>Debe tener al menos 3 caracteres.</mat-error>
              } @else if (profileForm.get('name')?.hasError('maxlength')) {
                <mat-error>Máximo 80 caracteres.</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Apellido</mat-label>
              <input matInput formControlName="lastName" autocomplete="off" [disabled]="!canEditProfile">
              @if (profileForm.get('lastName')?.hasError('minlength')) {
                <mat-error>Debe tener al menos 2 caracteres.</mat-error>
              } @else if (profileForm.get('lastName')?.hasError('maxlength')) {
                <mat-error>Máximo 80 caracteres.</mat-error>
              }
            </mat-form-field>

            @if (profileError) {
              <div class="profile-error">
                <mat-icon color="warn">warning</mat-icon>
                <span>{{ profileError }}</span>
              </div>
            }
          </div>
        </div>

        <div class="profile-form__actions">
          <button mat-stroked-button type="button" (click)="resetProfileForm()" [disabled]="savingProfile || !isProfileDirty">
            Restablecer
          </button>
          <button mat-raised-button color="accent" type="submit" [disabled]="!canSubmitProfile">
            Guardar cambios
          </button>
        </div>
      </form>
    </mat-card>
  }

  @if (viewingSelf && !accountUser?.athleteId) {
    <mat-card class="panel notice-card mat-elevation-z2">
      <div class="notice-card__content">
        <mat-icon color="primary">info</mat-icon>
        <div>
          <h3>Completa tu perfil deportivo</h3>
          <p class="muted">
            Puedes actualizar tu nombre y apellido en esta página. Si más adelante te asignamos un perfil de nadador,
            verás aquí tus resultados, rankings y competiciones asociadas.
          </p>
        </div>
      </div>
    </mat-card>
  }

  <div class="grid">
    <mat-card class="panel mat-elevation-z3">
      <div class="panel__header">
        <div>
          <p class="eyebrow">Comparacion</p>
          <h3>Promedio de su categoria</h3>
        </div>
      </div>
      @if (averages.athleteBest !== null && averages.categoryAverage !== null) {
        <div class="average-row">
          <div>
            <p class="small-label">Tu mejor</p>
            <h4>{{ formatSeconds(averages.athleteBest) }}</h4>
          </div>
          <div>
            <p class="small-label">Promedio listado</p>
            <h4>{{ formatSeconds(averages.categoryAverage) }}</h4>
          </div>
        </div>
        <div class="gap-row">
          <span class="gap-label" [class.positive]="averages.diff !== null && averages.diff < 0">
            {{ averageDiffLabel() }} ({{ averageGapSeconds() }})
          </span>
          <mat-progress-bar
            mode="determinate"
            [color]="averages.diff !== null && averages.diff <= 0 ? 'primary' : 'warn'"
            [value]="progressValue()">
          </mat-progress-bar>
        </div>
      } @else {
        <div class="empty">Necesitamos al menos una marca tuya y datos de la prueba para comparar.</div>
      }
    </mat-card>

    <mat-card class="panel mat-elevation-z3">
      <div class="panel__header">
        <div>
          <p class="eyebrow">Eventos próximos</p>
          <h3>Calendario sugerido</h3>
          @if (upcomingEvents.length) {
            <p class="panel__subtitle">{{ upcomingEvents.length }} evento(s) disponible(s)</p>
          }
        </div>
        @if (loadingCompetitions) { <mat-progress-spinner diameter="28" mode="indeterminate"></mat-progress-spinner> }
      </div>
      @if (upcomingEvents.length) {
        <div class="events-scroll">
          <mat-list class="events-list">
            @for (event of upcomingEvents; track event.name) {
              <mat-list-item>
                <div class="event-content">
                  <div class="event-title">{{ event.name }}</div>
                  <div class="muted">
                    @if (event.city) {
                      <mat-icon inline>location_on</mat-icon>
                      {{ event.city }}
                    }
                    @if (event.countryCode) {
                      · {{ event.countryCode }}
                    }
                    @if (event.startDate || event.date || event.endDate) {
                      ·
                      <mat-icon inline>event</mat-icon>
                      {{ formatDateLabel(event.startDate || event.date || event.endDate) }}
                    }
                  </div>
                  <mat-chip-set class="event-tags">
                    @if (event.poolName) { <mat-chip>{{ event.poolName }}</mat-chip> }
                    @if (event.status) { <mat-chip>{{ event.status | titlecase }}</mat-chip> }
                    @if (event.stage) { <mat-chip color="primary" selected>{{ event.stage }}</mat-chip> }
                  </mat-chip-set>
                </div>
              </mat-list-item>
            }
          </mat-list>
        </div>
      } @else if (!loadingCompetitions) {
        <div class="empty">
          <mat-icon>event_busy</mat-icon>
          <p>No hay eventos próximos para este país o disciplina.</p>
        </div>
      }
    </mat-card>

    <mat-card class="panel mat-elevation-z3">
      <div class="panel__header">
        <div>
          <p class="eyebrow">Datos biometricos</p>
          <h3>Ficha rapida</h3>
        </div>
        @if (loadingBio) { <mat-progress-spinner diameter="28" mode="indeterminate"></mat-progress-spinner> }
      </div>
      <div class="bio-grid">
        <div class="bio-item">
          <span class="label">Edad</span>
          <span class="value">{{ athlete.age || 'Sin dato' }}</span>
        </div>
        <div class="bio-item">
          <span class="label">Nacimiento</span>
          <span class="value">{{ athlete.birth || 'No disponible' }}</span>
        </div>
        <div class="bio-item">
          <span class="label">Nacionalidad</span>
          <span class="value">{{ athlete.nationality || athlete.country || 'Sin pais' }}</span>
        </div>
        <div class="bio-item">
          <span class="label">Altura</span>
          <span class="value">{{ athlete.height || 'Pendiente' }}</span>
        </div>
        <div class="bio-item">
          <span class="label">Peso</span>
          <span class="value">{{ athlete.weight || 'Pendiente' }}</span>
        </div>
        <div class="bio-item">
          <span class="label">Club / Equipo</span>
          <span class="value">{{ athlete.club || 'No registrado' }}</span>
        </div>
      </div>
    </mat-card>

    <mat-card class="panel mat-elevation-z3 records-panel">
      @if (records.length) {
        <div class="records-list">
          @for (record of records; track record.label) {
            <div class="record-card">
              <div class="record-card__header">
                <span class="record-label">{{ record.label }}</span>
                @if (record.points) {
                  <span class="points-chip">{{ record.points }} pts</span>
                }
              </div>
              <div class="record-card__body">
                <div>
                  <p class="small-label">Mejor tiempo</p>
                  <h4>{{ record.bestTime }}</h4>
                </div>
                <div>
                  <p class="small-label">Fecha</p>
                  <p class="muted">{{ record.date || 'Sin dato' }}</p>
                </div>
              </div>
            </div>
          }
        </div>
      } @else {
        <div class="empty">Sin registros para este nadador en este filtro.</div>
      }
    </mat-card>

    @if (athlete.athleteId) {
      <mat-card class="panel panel--full-width mat-elevation-z3">
        <div class="panel__header">
          <div>
            <p class="eyebrow">Historial completo</p>
            <h3>Resultados de competiciones</h3>
            @if (dbResults.length) {
              <p class="panel__subtitle">{{ dbResults.length }} resultado(s) registrado(s)</p>
            }
          </div>
        </div>

        @if (dbResults.length > 0) {
          <div class="results-table-wrapper">
            <table class="results-table">
              <thead>
                <tr>
                  <th>Prueba</th>
                  <th>Tiempo</th>
                  <th class="text-center">Medalla</th>
                  <th class="text-center">Piscina</th>
                  <th>Competición</th>
                  <th class="text-center">País</th>
                  <th class="text-center">Fecha</th>
                  <th class="text-center">Records</th>
                </tr>
              </thead>
              <tbody>
                @for (r of dbResults; track r.id) {
                  <tr class="result-row">
                    <td class="event-cell" data-label="Prueba">
                      <strong>{{ r.event }}</strong>
                    </td>
                    <td class="time-cell" data-label="Tiempo">
                      <span class="time-badge">{{ r.timeText }}</span>
                    </td>
                    <td class="text-center medal-cell" data-label="Medalla">
                      @if (r.medal) {
                        <span class="medal-badge" [class.gold]="r.medal === 'Gold'"
                              [class.silver]="r.medal === 'Silver'" [class.bronze]="r.medal === 'Bronze'">
                          @if (r.medal === 'Gold') {
                            <mat-icon>emoji_events</mat-icon>
                          }
                          @if (r.medal === 'Silver') {
                            <mat-icon>military_tech</mat-icon>
                          }
                          @if (r.medal === 'Bronze') {
                            <mat-icon>workspace_premium</mat-icon>
                          }
                          {{ r.medal }}
                        </span>
                      }
                      @if (!r.medal) {
                        <span class="muted">-</span>
                      }
                    </td>
                    <td class="text-center" data-label="Piscina">
                      @if (r.poolLength) {
                        <span class="pool-badge">{{ r.poolLength }}</span>
                      }
                      @if (!r.poolLength) {
                        <span class="muted">-</span>
                      }
                    </td>
                    <td class="competition-cell" data-label="Competición">
                      <span class="competition-name">{{ r.competition || 'Sin competición' }}</span>
                    </td>
                    <td class="text-center" data-label="País">
                      @if (r.compCountryCode) {
                        <span class="country-badge">{{ r.compCountryCode }}</span>
                      }
                      @if (!r.compCountryCode) {
                        <span class="muted">-</span>
                      }
                    </td>
                    <td class="text-center date-cell" data-label="Fecha">
                      <span class="date-text">{{ formatDateLabel(r.raceDate) }}</span>
                    </td>
                    <td class="text-center records-cell" data-label="Records">
                      @if (r.recordTags) {
                        <span class="record-tag">{{ r.recordTags }}</span>
                      }
                      @if (!r.recordTags) {
                        <span class="muted">-</span>
                      }
                    </td>
                  </tr>
                }
              </tbody>
            </table>
        </div>
      }

      @if (dbResults.length === 0 && !loading) {
        <div class="results-empty">
          <mat-icon>info</mat-icon>
          <p>No hay resultados registrados en la base de datos para este atleta.</p>
          <small class="muted">ID del atleta: {{ athlete.athleteId }}</small>
        </div>
      }
      </mat-card>
    }
  </div>

  @if (rankingError) {
    <div class="error-box">
      <mat-icon color="warn">error</mat-icon>
      <span>{{ rankingError }}</span>
    </div>
  }
</div>
