<div class="ranking-container mat-elevation-z4">
  <form class="filters" (ngSubmit)="cargarRankings(); $event.preventDefault();">
    <mat-form-field appearance="outline">
      <mat-label>Sexo</mat-label>
      <mat-select [(ngModel)]="gender" name="gender">
        @for(g of genders; track $index){
          <mat-option [value]="g.val">{{ g.label }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Distancia</mat-label>
      <mat-select [(ngModel)]="distance" name="distance">
        @for(d of distances; track $index){
          <mat-option [value]="d">{{ d }} m</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Estilo</mat-label>
      <mat-select [(ngModel)]="stroke" name="stroke">
        @for(s of filteredStrokes; track s.val){
          <mat-option [value]="s.val">{{ s.label }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Piscina</mat-label>
      <mat-select [(ngModel)]="poolConfiguration" name="poolConfiguration">
        @for(p of pools; track $index){
          <mat-option [value]="p.val">{{ p.label }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" style="width: 120px;">
      <mat-label>Límite</mat-label>
      <input matInput type="number" [(ngModel)]="limit" name="limit" min="1" max="200">
    </mat-form-field>

    <button mat-raised-button color="primary" type="submit" class="btn">Buscar</button>
  </form>

  @if(loading) {
    <div class="loading" style="display: flex; align-items: center;">
      <mat-progress-spinner mode="indeterminate" diameter="32"></mat-progress-spinner>
      <span style="margin-left: 1em;">Cargando...</span>
    </div>
  }
  @if (error) {
    <div class="error mat-elevation-z2" style="display: flex; align-items: center;">
      <mat-icon color="warn">error</mat-icon>
      <span style="margin-left: 0.5em;">{{ error }}</span>
    </div>
  }
  @if(!loading && nadadores.length > 0){
    <table mat-table [dataSource]="nadadores" class="ranking-table mat-elevation-z2">
      <!-- Numero en el Ranking -->
      <ng-container matColumnDef="overallRank">
        <th mat-header-cell *matHeaderCellDef>Ranking</th>
        <td mat-cell *matCellDef="let n">{{ n.overallRank }}</td>
      </ng-container>
      <!-- País -->
      <ng-container matColumnDef="country">
        <th mat-header-cell *matHeaderCellDef>País</th>
        <td mat-cell *matCellDef="let n">
          <span>{{ n.country | countryFlag }}</span>
          <span style="margin-left: 0.3em;">{{ n.country }}</span>
        </td>
      </ng-container>
      <!-- Nombre -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Nombre</th>
        <td mat-cell *matCellDef="let n">{{ n.name }}</td>
      </ng-container>
      <!-- Edad -->
      <ng-container matColumnDef="age">
        <th mat-header-cell *matHeaderCellDef>Edad</th>
        <td mat-cell *matCellDef="let n">{{ n.age }}</td>
      </ng-container>
      <!-- Tiempo -->
      <ng-container matColumnDef="time">
        <th mat-header-cell *matHeaderCellDef>Tiempo</th>
        <td mat-cell *matCellDef="let n">{{ n.time }}</td>
      </ng-container>
      <!-- Puntos FINA -->
      <ng-container matColumnDef="points">
        <th mat-header-cell *matHeaderCellDef>Puntos FINA</th>
        <td mat-cell *matCellDef="let n">{{ n.points }}</td>
      </ng-container>
      <!-- Tipo de marca -->
      <ng-container matColumnDef="tag">
        <th mat-header-cell *matHeaderCellDef>Tipo de marca</th>
        <td mat-cell *matCellDef="let n">{{ n.tag }}</td>
      </ng-container>
      <!-- Competición -->
      <ng-container matColumnDef="competition">
        <th mat-header-cell *matHeaderCellDef>Competición</th>
        <td mat-cell *matCellDef="let n">{{ n.competition }}</td>
      </ng-container>
      <!-- País de la competición -->
      <ng-container matColumnDef="location">
        <th mat-header-cell *matHeaderCellDef>País competición</th>
        <td mat-cell *matCellDef="let n">
          <span>{{ n.location | countryFlag }}</span>
          <span style="margin-left: 0.3em;">{{ n.location }}</span>
        </td>
      </ng-container>
      <!-- Fecha -->
      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef>Fecha</th>
        <td mat-cell *matCellDef="let n">{{ n.date }}</td>
      </ng-container>
      <!-- Acciones -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let n">
          <button mat-stroked-button color="accent" (click)="verTimeline(n)">
            <mat-icon>timeline</mat-icon> Timeline
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="['overallRank','country','name','age','time','points','tag','competition','location','date','actions']"></tr>
      <tr mat-row *matRowDef="let row; columns: ['overallRank','country','name','age','time','points','tag','competition','location','date','actions'];"></tr>
    </table>
  }
  @if (!loading && (!nadadores || nadadores.length === 0)){
    <div class="age-note mat-elevation-z1" style="display: flex; align-items: center;">
      <mat-icon color="accent">info</mat-icon>
      <span style="margin-left: 0.5em;">No hay resultados</span>
    </div>
  }
</div>

<!-- El timeline ahora se muestra en un MatDialog al pulsar el botón 'Timeline' -->
