<div class="ranking-container mat-elevation-z4">
  <form class="filters" [formGroup]="rankingForm" (ngSubmit)="onSubmit($event)">

    <mat-form-field appearance="outline">
      <mat-label>Sexo</mat-label>
      <mat-select formControlName="gender">
        @for(g of genders; track $index){
          <mat-option [value]="g.val">{{ g.label }}</mat-option>
        }
      </mat-select>
      @if(hasError('gender')) {
        <mat-error>{{ getErrorMessage('gender') }}</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Distancia</mat-label>
      <mat-select formControlName="distance">
        @for(d of distances; track $index){
          <mat-option [value]="d">{{ d }} m</mat-option>
        }
      </mat-select>
      @if(hasError('distance')) {
        <mat-error>{{ getErrorMessage('distance') }}</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Estilo</mat-label>
      <mat-select formControlName="stroke">
        @for(s of filteredStrokes; track s.val){
          <mat-option [value]="s.val">{{ s.label }}</mat-option>
        }
      </mat-select>
      @if(hasError('stroke')) {
        <mat-error>{{ getErrorMessage('stroke') }}</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Piscina</mat-label>
      <mat-select formControlName="poolConfiguration">
        @for(p of pools; track $index){
          <mat-option [value]="p.val">{{ p.label }}</mat-option>
        }
      </mat-select>
      @if(hasError('poolConfiguration')) {
        <mat-error>{{ getErrorMessage('poolConfiguration') }}</mat-error>
      }
    </mat-form-field>

    <button
      mat-raised-button
      color="primary"
      type="submit"
      class="btn"
      [disabled]="loading || rankingForm.invalid"
    >
      @if(loading) {
        Cargando...
      } @else {
        Buscar
      }
    </button>

  </form>

  @if(loading) {
    <div class="loading" style="display: flex; align-items: center;">
      <mat-progress-spinner mode="indeterminate" diameter="32"></mat-progress-spinner>
      <span style="margin-left: 1em;">Cargando...</span>
    </div>
  }
  @if (error) {
    <div class="error mat-elevation-z2" style="display: flex; align-items: center;">
      <mat-icon color="warn">error</mat-icon>
      <span style="margin-left: 0.5em;">{{ error }}</span>
    </div>
  }
  @if(!loading && nadadores.length > 0){
    <div class="table-wrapper desktop-table">
    <table mat-table [dataSource]="nadadores" class="ranking-table mat-elevation-z2">
      <ng-container matColumnDef="overallRank">
        <th mat-header-cell *matHeaderCellDef>#</th>
        <td mat-cell *matCellDef="let n" data-label="Posicion">
          <span class="rank-badge" [ngClass]="{'gold': n.overallRank === 1, 'silver': n.overallRank === 2, 'bronze': n.overallRank === 3}">
            {{ n.overallRank }}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="athlete">
        <th mat-header-cell *matHeaderCellDef>Atleta</th>
        <td mat-cell *matCellDef="let n" data-label="Atleta">
          <div class="athlete-cell">
            @if(n.imageUrl) {
              <img [src]="n.imageUrl" [alt]="n.name" class="athlete-photo" (error)="onImageError($event)" loading="lazy">
            } @else {
              <div class="athlete-photo-placeholder">
                <mat-icon>person</mat-icon>
              </div>
            }
            <div class="athlete-meta">
              <div class="name-line">
                <span>{{ n.name }}</span>
              </div>
              <div class="meta-line">
                <span class="country-flag">{{ n.country | countryFlag }}</span>
                <span class="country-code">{{ n.country }}</span>
                @if(n.age){
                  <span class="dot">&middot;</span>
                  <span>{{ n.age }} anios</span>
                }
              </div>
              <div class="meta-line detail">
                <span class="pill">{{ n.distance }}m</span>
                <span class="pill">{{ n.stroke }}</span>
                <span class="pill">{{ n.poolConfiguration }}</span>
              </div>
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="performance">
        <th mat-header-cell *matHeaderCellDef>Marca</th>
        <td mat-cell *matCellDef="let n" data-label="Marca">
          <div class="performance">
            <div class="time-block">
              <span class="time-text">{{ n.time }}</span>
              @if(n.recordTag){
                <span class="record-tag">{{ n.recordTag }}</span>
              }
            </div>
            <div class="tags">
              @if(n.points){
                <span class="points-chip">{{ n.points }} pts</span>
              }
              @if(n.tag){
                <span class="pill neutral">{{ n.tag }}</span>
              }
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="competition">
        <th mat-header-cell *matHeaderCellDef>Competicion</th>
        <td mat-cell *matCellDef="let n" data-label="Competicion">
          <div class="competition">
            <div class="competition-name">{{ n.competition || '-' }}</div>
            <div class="meta-line">
              <span>{{ n.location | countryFlag }}</span>
              <span class="country-code">{{ n.location }}</span>
            </div>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef>Fecha</th>
        <td mat-cell *matCellDef="let n" data-label="Fecha">{{ n.date }}</td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let n" data-label="Acciones" class="actions-cell">
          <button mat-stroked-button color="accent" (click)="verTimeline(n)">
            <mat-icon>timeline</mat-icon> Timeline
          </button>
          <button mat-stroked-button color="primary" (click)="verPerfil(n)">
            <mat-icon>person</mat-icon> Perfil
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="['overallRank','athlete','performance','competition','date','actions']"></tr>
      <tr mat-row *matRowDef="let row; columns: ['overallRank','athlete','performance','competition','date','actions'];"></tr>
    </table>
    </div>

    <div class="mobile-ranking">
      @for (n of nadadores; track $index) {
        <article class="mobile-card mat-elevation-z2">
          <div class="mobile-card__header">
            <span class="rank-badge" [ngClass]="{'gold': n.overallRank === 1, 'silver': n.overallRank === 2, 'bronze': n.overallRank === 3}">
              {{ n.overallRank }}
            </span>
            <div class="mobile-card__athlete">
              <div class="mobile-avatar">
                @if (n.imageUrl) {
                  <img [src]="n.imageUrl" [alt]="n.name" loading="lazy" (error)="onImageError($event)">
                } @else {
                  <mat-icon>person</mat-icon>
                }
              </div>
              <div class="mobile-card__identity">
                <strong>{{ n.name }}</strong>
                <small class="muted-line">
                  <span>{{ n.country | countryFlag }} {{ n.country }}</span>
                  @if(n.age){
                    <span>&middot; {{ n.age }} anios</span>
                  }
                </small>
              </div>
            </div>
          </div>

          <div class="mobile-card__section">
            <span class="section-label">Marca</span>
            <div class="mobile-card__value">
              <span class="time-text">{{ n.time }}</span>
              @if(n.recordTag){
                <span class="record-tag">{{ n.recordTag }}</span>
              }
            </div>
            <div class="mobile-card__tags">
              <span class="pill">{{ n.distance }}m</span>
              <span class="pill">{{ n.stroke }}</span>
              <span class="pill">{{ n.poolConfiguration }}</span>
              @if(n.points){
                <span class="points-chip">{{ n.points }} pts</span>
              }
              @if(n.tag){
                <span class="pill neutral">{{ n.tag }}</span>
              }
            </div>
          </div>

          <div class="mobile-card__section">
            <span class="section-label">Competicion</span>
            <div class="mobile-card__value">
              <strong>{{ n.competition || '-' }}</strong>
              <small class="muted-line">
                <span>{{ n.location | countryFlag }} {{ n.location }}</span>
                <span>Â· {{ n.date }}</span>
              </small>
            </div>
          </div>

          <div class="mobile-card__actions">
            <button mat-stroked-button color="accent" (click)="verTimeline(n)">
              <mat-icon>timeline</mat-icon>
              Timeline
            </button>
            <button mat-raised-button color="primary" (click)="verPerfil(n)">
              <mat-icon>person</mat-icon>
              Perfil
            </button>
          </div>
        </article>
      }
    </div>

    <!-- Informacion de paginacion y boton "Cargar mas" -->
    @if(hayMasRegistros) {
      <div class="pagination-info mat-elevation-z1">
        <div class="records-info">
          <mat-icon color="primary">info_outline</mat-icon>
          <span>{{ textoRegistrosCargados }}</span>
        </div>
        <button
          mat-raised-button
          color="accent"
          (click)="cargarMasRegistros()"
          [disabled]="loading"
          class="load-more-btn"
        >
          @if(loading) {
            <ng-container>
              <mat-progress-spinner mode="indeterminate" diameter="20" style="display: inline-block;"></mat-progress-spinner>
              <span style="margin-left: 0.5em;">Cargando...</span>
            </ng-container>
          } @else {
            <ng-container>
              <mat-icon>expand_more</mat-icon>
              <span>Cargar mas registros</span>
            </ng-container>
          }
        </button>
      </div>
    }
  }
  @if (!loading && (!nadadores || nadadores.length === 0)){
    <div class="age-note mat-elevation-z1" style="display: flex; align-items: center;">
      <mat-icon color="accent">info</mat-icon>
      <span style="margin-left: 0.5em;">No hay resultados</span>
    </div>
  }
</div>


