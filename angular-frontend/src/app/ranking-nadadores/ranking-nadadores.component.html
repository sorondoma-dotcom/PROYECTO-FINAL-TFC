<div class="ranking-container mat-elevation-z4">
  <form class="filters" [formGroup]="rankingForm" (ngSubmit)="onSubmit($event)">

    <mat-form-field appearance="outline">
      <mat-label>Sexo</mat-label>
      <mat-select formControlName="gender">
        @for(g of genders; track $index){
          <mat-option [value]="g.val">{{ g.label }}</mat-option>
        }
      </mat-select>
      @if(hasError('gender')) {
        <mat-error>{{ getErrorMessage('gender') }}</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Distancia</mat-label>
      <mat-select formControlName="distance">
        @for(d of distances; track $index){
          <mat-option [value]="d">{{ d }} m</mat-option>
        }
      </mat-select>
      @if(hasError('distance')) {
        <mat-error>{{ getErrorMessage('distance') }}</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Estilo</mat-label>
      <mat-select formControlName="stroke">
        @for(s of filteredStrokes; track s.val){
          <mat-option [value]="s.val">{{ s.label }}</mat-option>
        }
      </mat-select>
      @if(hasError('stroke')) {
        <mat-error>{{ getErrorMessage('stroke') }}</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Piscina</mat-label>
      <mat-select formControlName="poolConfiguration">
        @for(p of pools; track $index){
          <mat-option [value]="p.val">{{ p.label }}</mat-option>
        }
      </mat-select>
      @if(hasError('poolConfiguration')) {
        <mat-error>{{ getErrorMessage('poolConfiguration') }}</mat-error>
      }
    </mat-form-field>

    <button
      mat-raised-button
      color="primary"
      type="submit"
      class="btn"
      [disabled]="loading || rankingForm.invalid"
    >
      @if(loading) {
        Cargando...
      } @else {
        Buscar
      }
    </button>

  </form>

  @if(loading) {
    <div class="loading" style="display: flex; align-items: center;">
      <mat-progress-spinner mode="indeterminate" diameter="32"></mat-progress-spinner>
      <span style="margin-left: 1em;">Cargando...</span>
    </div>
  }
  @if (error) {
    <div class="error mat-elevation-z2" style="display: flex; align-items: center;">
      <mat-icon color="warn">error</mat-icon>
      <span style="margin-left: 0.5em;">{{ error }}</span>
    </div>
  }
  @if(!loading && nadadores.length > 0){
    <div class="table-wrapper">
    <table mat-table [dataSource]="nadadores" class="ranking-table mat-elevation-z2">
      <!-- Numero en el Ranking -->
      <ng-container matColumnDef="overallRank">
        <th mat-header-cell *matHeaderCellDef>Ranking</th>
        <td mat-cell *matCellDef="let n" data-label="Ranking">{{ n.overallRank }}</td>
      </ng-container>
      <!-- País -->
      <ng-container matColumnDef="country">
        <th mat-header-cell *matHeaderCellDef>País</th>
        <td mat-cell *matCellDef="let n" data-label="País">
          <span>{{ n.country | countryFlag }}</span>
          <span style="margin-left: 0.3em;">{{ n.country }}</span>
        </td>
      </ng-container>
      <!-- Nombre con imagen -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Nadador</th>
        <td mat-cell *matCellDef="let n" data-label="Nadador">
          <div style="display: flex; align-items: center; gap: 0.75rem;">
            @if(n.imageUrl) {
              <img
                [src]="n.imageUrl"
                [alt]="n.name"
                class="athlete-photo"
                (error)="onImageError($event)"
                loading="lazy"
              >
            } @else {
              <div class="athlete-photo-placeholder">
                <mat-icon>person</mat-icon>
              </div>
            }
            <div class="athlete-name-wrapper">
              @if(n.profileUrl) {
                <a [href]="n.profileUrl" target="_blank" rel="noopener noreferrer" class="athlete-link">
                  {{ n.name }}
                  <mat-icon class="external-link-icon">open_in_new</mat-icon>
                </a>
              } @else {
                <span>{{ n.name }}</span>
              }
            </div>
          </div>
        </td>
      </ng-container>
      <!-- Edad -->
      <ng-container matColumnDef="age">
        <th mat-header-cell *matHeaderCellDef>Edad</th>
        <td mat-cell *matCellDef="let n" data-label="Edad">{{ n.age }}</td>
      </ng-container>
      <!-- Tiempo -->
      <ng-container matColumnDef="time">
        <th mat-header-cell *matHeaderCellDef>Tiempo</th>
        <td mat-cell *matCellDef="let n" data-label="Tiempo">{{ n.time }}</td>
      </ng-container>
      <!-- Puntos FINA -->
      <ng-container matColumnDef="points">
        <th mat-header-cell *matHeaderCellDef>Puntos FINA</th>
        <td mat-cell *matCellDef="let n" data-label="Puntos FINA">{{ n.points }}</td>
      </ng-container>
      <!-- Tipo de marca -->
      <ng-container matColumnDef="tag">
        <th mat-header-cell *matHeaderCellDef>Tipo de marca</th>
        <td mat-cell *matCellDef="let n" data-label="Tipo de marca">{{ n.tag }}</td>
      </ng-container>
      <!-- Competición -->
      <ng-container matColumnDef="competition">
        <th mat-header-cell *matHeaderCellDef>Competición</th>
        <td mat-cell *matCellDef="let n" data-label="Competición">{{ n.competition }}</td>
      </ng-container>
      <!-- País de la competición -->
      <ng-container matColumnDef="location">
        <th mat-header-cell *matHeaderCellDef>País competición</th>
        <td mat-cell *matCellDef="let n" data-label="País competición">
          <span>{{ n.location | countryFlag }}</span>
          <span style="margin-left: 0.3em;">{{ n.location }}</span>
        </td>
      </ng-container>
      <!-- Fecha -->
      <ng-container matColumnDef="date">
        <th mat-header-cell *matHeaderCellDef>Fecha</th>
        <td mat-cell *matCellDef="let n" data-label="Fecha">{{ n.date }}</td>
      </ng-container>
      <!-- Acciones -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Ver Timeline</th>
        <td mat-cell *matCellDef="let n" data-label="Timeline" class="actions-cell">
          <button mat-stroked-button color="accent" (click)="verTimeline(n)">
            <mat-icon>timeline</mat-icon> Timeline
          </button>
        </td>
      </ng-container>
      <!-- Perfil -->
      <ng-container matColumnDef="profile">
        <th mat-header-cell *matHeaderCellDef>Perfil</th>
        <td mat-cell *matCellDef="let n" data-label="Perfil" class="actions-cell">
          <button mat-stroked-button color="primary" (click)="verPerfil(n)">
            <mat-icon>person</mat-icon> Perfil
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="['overallRank','country','name','age','time','points','tag','competition','location','date','actions','profile']"></tr>
      <tr mat-row *matRowDef="let row; columns: ['overallRank','country','name','age','time','points','tag','competition','location','date','actions','profile'];"></tr>
    </table>
    </div>

    <!-- Información de paginación y botón "Cargar más" -->
    @if(hayMasRegistros) {
      <div class="pagination-info mat-elevation-z1">
        <div class="records-info">
          <mat-icon color="primary">info_outline</mat-icon>
          <span>{{ textoRegistrosCargados }}</span>
        </div>
        <button
          mat-raised-button
          color="accent"
          (click)="cargarMasRegistros()"
          [disabled]="loading"
          class="load-more-btn"
        >
          @if(loading) {
            <ng-container>
              <mat-progress-spinner mode="indeterminate" diameter="20" style="display: inline-block;"></mat-progress-spinner>
              <span style="margin-left: 0.5em;">Cargando...</span>
            </ng-container>
          } @else {
            <ng-container>
              <mat-icon>expand_more</mat-icon>
              <span>Cargar más registros</span>
            </ng-container>
          }
        </button>
      </div>
    }
  }
  @if (!loading && (!nadadores || nadadores.length === 0)){
    <div class="age-note mat-elevation-z1" style="display: flex; align-items: center;">
      <mat-icon color="accent">info</mat-icon>
      <span style="margin-left: 0.5em;">No hay resultados</span>
    </div>
  }
</div>


